<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App | Modern Task Manager</title>
    <link rel="stylesheet" href="/styles.css" />
    <!-- <link rel="stylesheet" href="/fanta.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-rerrer" />
</head>

<body>
    <!-- Auth Section -->
    <section id="auth" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="app-icon">
                    <i class="fa-solid fa-check-double"></i>
                </div>
                <h2 id="authTitle">Welcome Back</h2>
                <p id="authSubtitle">Sign in to manage your tasks</p>
            </div>

            <div class="auth-form">
                <p id="error" class="error-message"></p>
                
                <div class="input-group">
                    <i class="fa-solid fa-user input-icon"></i>
                    <input id="emailInput" placeholder="Username" autocomplete="username" />
                </div>

                <div class="input-group">
                    <i class="fa-solid fa-lock input-icon"></i>
                    <input id="passwordInput" placeholder="Password" type="password" autocomplete="current-password" />
                </div>

                <button id="authBtn" class="btn-primary" onclick="authenticate()">
                    <span>Sign In</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>

                <div class="auth-divider">
                    <span>or</span>
                </div>

                <div class="auth-switch">
                    <p id="switchText">Don't have an account?</p>
                    <button onclick="toggleIsRegister()" id="registerBtn" class="btn-link">
                        Create Account
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="user-section">
                <div class="user-avatar">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="user-info">
                    <h3 id="userName">Welcome back!</h3>
                    <p id="userStats">Let's get things done</p>
                </div>
            </div>
            <button class="btn-logout" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Logout</span>
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-container">
            <div class="stat-card stat-all">
                <div class="stat-icon">
                    <i class="fa-solid fa-list-check"></i>
                </div>
                <div class="stat-content">
                    <h4 id="statAll">0</h4>
                    <p>Total Tasks</p>
                </div>
            </div>
            <div class="stat-card stat-open">
                <div class="stat-icon">
                    <i class="fa-solid fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h4 id="statOpen">0</h4>
                    <p>Active</p>
                </div>
            </div>
            <div class="stat-card stat-complete">
                <div class="stat-icon">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
                <div class="stat-content">
                    <h4 id="statComplete">0</h4>
                    <p>Completed</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <nav class="tabs-container">
            <button onclick="changeTab('All')" class="tab-btn active" data-tab="All">
                <i class="fa-solid fa-list"></i>
                <span>All Tasks</span>
                <span class="tab-count" id="countAll">0</span>
            </button>
            <button onclick="changeTab('Open')" class="tab-btn" data-tab="Open">
                <i class="fa-solid fa-hourglass-half"></i>
                <span>Active</span>
                <span class="tab-count" id="countOpen">0</span>
            </button>
            <button onclick="changeTab('Complete')" class="tab-btn" data-tab="Complete">
                <i class="fa-solid fa-check-circle"></i>
                <span>Completed</span>
                <span class="tab-count" id="countComplete">0</span>
            </button>
        </nav>

        <!-- Add Todo Input -->
        <div class="add-todo-container">
            <div class="add-todo-input">
                <i class="fa-solid fa-plus"></i>
                <input id="todoInput" placeholder="Add a new task..." onkeypress="handleEnterKey(event)" />
                <button onclick="addTodo()" class="btn-add">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Todos List -->
        <main id="todosList" class="todos-list">
            <!-- Todos will be rendered here -->
        </main>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fa-solid fa-inbox"></i>
            <h3>No tasks yet</h3>
            <p>Add your first task to get started!</p>
        </div>
    </div>
</body>

<script>
    let token = localStorage.getItem('token')
    let isLoading = false
    let isAuthenticating = false
    let isRegistration = false
    let selectedTab = 'All'
    let todos = []

    const apiBase = '/'

    // Elements
    const dashboard = document.getElementById('dashboard')
    const authContent = document.getElementById('auth')
    const textError = document.getElementById('error')
    const email = document.getElementById('emailInput')
    const password = document.getElementById('passwordInput')
    const registerBtn = document.getElementById('registerBtn')
    const authBtn = document.getElementById('authBtn')
    const todosList = document.getElementById('todosList')
    const emptyState = document.getElementById('emptyState')

    // PAGE RENDERING
    async function showDashboard() {
        dashboard.style.display = 'block'
        authContent.style.display = 'none'
        await fetchTodos()
    }

    function updateStats() {
        const all = todos.length
        const open = todos.filter(t => !t.completed).length
        const complete = todos.filter(t => t.completed).length

        document.getElementById('statAll').textContent = all
        document.getElementById('statOpen').textContent = open
        document.getElementById('statComplete').textContent = complete
        document.getElementById('countAll').textContent = all
        document.getElementById('countOpen').textContent = open
        document.getElementById('countComplete').textContent = complete

        const userStats = document.getElementById('userStats')
        if (open === 0 && all > 0) {
            userStats.textContent = "ðŸŽ‰ All tasks completed!"
        } else if (open === 1) {
            userStats.textContent = "1 task pending"
        } else {
            userStats.textContent = `${open} tasks pending`
        }
    }

    function changeTab(tab) {
        selectedTab = tab
        document.querySelectorAll('.tab-btn').forEach(btn => {
            if (btn.dataset.tab === tab) {
                btn.classList.add('active')
            } else {
                btn.classList.remove('active')
            }
        })
        renderTodos()
    }

    function renderTodos() {
        updateStats()

        const filteredTodos = todos.filter(val => {
            if (selectedTab === 'All') return true
            if (selectedTab === 'Complete') return val.completed
            return !val.completed
        })

        if (filteredTodos.length === 0) {
            todosList.style.display = 'none'
            emptyState.style.display = 'flex'
            return
        }

        todosList.style.display = 'grid'
        emptyState.style.display = 'none'

        let todoHTML = ''
        filteredTodos.forEach(todo => {
            todoHTML += `
            <div class="todo-card ${todo.completed ? 'completed' : ''}">
                <div class="todo-checkbox" onclick="updateTodo(${todo.id})">
                    ${todo.completed ? '<i class="fa-solid fa-check"></i>' : ''}
                </div>
                <div class="todo-content">
                    <p class="todo-text">${escapeHtml(todo.task)}</p>
                </div>
                <button class="todo-delete" onclick="deleteTodo(${todo.id})" title="Delete task">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            `
        })
        todosList.innerHTML = todoHTML
    }

    function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
    }

    // AUTH
    async function toggleIsRegister() {
        isRegistration = !isRegistration
        const authTitle = document.getElementById('authTitle')
        const authSubtitle = document.getElementById('authSubtitle')
        const switchText = document.getElementById('switchText')
        
        if (isRegistration) {
            authTitle.textContent = 'Create Account'
            authSubtitle.textContent = 'Sign up to start managing your tasks'
            switchText.textContent = 'Already have an account?'
            registerBtn.textContent = 'Sign In'
            authBtn.querySelector('span').textContent = 'Sign Up'
        } else {
            authTitle.textContent = 'Welcome Back'
            authSubtitle.textContent = 'Sign in to manage your tasks'
            switchText.textContent = "Don't have an account?"
            registerBtn.textContent = 'Create Account'
            authBtn.querySelector('span').textContent = 'Sign In'
        }
    }

    async function authenticate() {
        const emailVal = email.value.trim()
        const passVal = password.value

        if (isLoading || isAuthenticating || !emailVal || !passVal || passVal.length < 6) {
            if (!emailVal || !passVal) {
                showError('Please fill in all fields')
            } else if (passVal.length < 6) {
                showError('Password must be at least 6 characters')
            }
            return
        }

        textError.style.display = 'none'
        isAuthenticating = true
        authBtn.classList.add('loading')
        authBtn.querySelector('span').textContent = 'Please wait...'

        try {
            const endpoint = isRegistration ? 'auth/register' : 'auth/login'
            const response = await fetch(apiBase + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: emailVal, password: passVal })
            })
            const data = await response.json()

            if (data.token) {
                token = data.token
                localStorage.setItem('token', token)
                await fetchTodos()
                showDashboard()
            } else {
                throw new Error(data.message || 'Authentication failed')
            }
        } catch (err) {
            showError(err.message || 'Failed to authenticate')
        } finally {
            authBtn.classList.remove('loading')
            authBtn.querySelector('span').textContent = isRegistration ? 'Sign Up' : 'Sign In'
            isAuthenticating = false
        }
    }

    function showError(message) {
        textError.textContent = message
        textError.style.display = 'block'
    }

    function logout() {
        localStorage.removeItem('token')
        token = null
        todos = []
        dashboard.style.display = 'none'
        authContent.style.display = 'flex'
        email.value = ''
        password.value = ''
    }

    // CRUD
    async function fetchTodos() {
        isLoading = true
        try {
            const response = await fetch(apiBase + 'todos', {
                headers: { 'Authorization': token }
            })
            todos = await response.json()
            renderTodos()
        } catch (err) {
            console.error('Failed to fetch todos:', err)
        } finally {
            isLoading = false
        }
    }

    async function updateTodo(id) {
        const todo = todos.find(t => t.id === id)
        if (!todo || todo.completed) return

        try {
            await fetch(apiBase + 'todos/' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ completed: 1 })
            })
            await fetchTodos()
        } catch (err) {
            console.error('Failed to update todo:', err)
        }
    }

    async function deleteTodo(id) {
        try {
            await fetch(apiBase + 'todos/' + id, {
                method: 'DELETE',
                headers: { 'Authorization': token }
            })
            await fetchTodos()
        } catch (err) {
            console.error('Failed to delete todo:', err)
        }
    }

    async function addTodo() {
        const todoInput = document.getElementById('todoInput')
        const task = todoInput.value.trim()

        if (!task) return

        try {
            await fetch(apiBase + 'todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ task })
            })
            todoInput.value = ''
            await fetchTodos()
        } catch (err) {
            console.error('Failed to add todo:', err)
        }
    }

    function handleEnterKey(event) {
        if (event.key === 'Enter') {
            addTodo()
        }
    }

    // Init
    if (token) {
        (async () => {
            await fetchTodos()
            showDashboard()
        })()
    }
</script>

</html>